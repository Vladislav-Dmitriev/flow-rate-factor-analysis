input_data_plan = {
    "base_prop": {
        "calc_type": 'optimal',  # тип расчета (optimal упрощенная модель, desuperposition с эффектом суперпозиции
        # давления, segmentation сегментация скважины на интервалы)
        "segment_count": 20,  # кол-во сегментов разбиения скважины
        "border_type_x": "n",  # тип граничного условия (c - непроницаемая граница, n - свободный поток через границы)
        "border_type_y": "n",  # тип граничного условия
        "border_type_z_up": "n",  # тип граничного условия
        "border_type_z_down": "n",  # тип граничного условия
    },
    "target": {
        "cumulative_time": 2400,  # накопленное время работы, в сутках
        "target_values": {
            "q_liq": 50,  # целевое значение дебита
            "p_bhp": 150  # целевое значение забойного давления
        },
    },
    "unit": {
        "skin": 0,  # скин-фактор
        "h_eff": 12,  # Эффективная толщина пласта
        "vertical_offset": 0.5,  #
        "perfres_ratio": 1,  # Вертикальное положение (в долях от мощности) (для горизонтальных)
        "wellbore_prop": {
            "wellbore_type": "horizontal",  # Тип скважины: вертикальная, горизонтальная или многозабойная
            "wellbore_r": 0.1,  # Радиус скважины, м
            "horizontal_wellbore_length": 624,  # Длина горизонтального ствола
            "horizontal_wellbore_perf_ratio": 1,  # Доля перфораций горизонтальной скважины
            "horizontal_perf_count": 5,  # Количество перфорированных интервалов
            "permeability": 100000000  # Проницаемость скважины
        },
        "layer_prop": {
            "permeability": 15,  # Проницаемость пласта, мД
            "water_cut": 12,  # Обводненность, %
            "p_bubble": 100,  # Давление насыщения, атм
            "kv_kh_ratio": 0.1,  # Отношение вертикальной к горизонтальной проницаемости
            "compressibility": 0.000151,  # Общая сжимаемость
            "porosity": 0.2,  # Пористость
            "p_res_init": 260,  # Начальное пластовое давление
            "viscosity_oil": 1,  # Вязкость нефти
            "b_oil": 1.2,  # Объемный коэффициент
            "res_model_type": "Homogeneous",  # Модель пласта
            "f_compressibility": 0.0001,  # Сжимаемость трещин
            "f_porosity": 0.001,  # Пористость трещин
            "lambda": 0.00001,  # Коэффициент пропускания
            "internal_r": None,  # Внутренний радиус (для составной модели пласта)
            "kmu_in_out_ratio": 2,  # (k/mu)_in / (k/mu)_out
            "kmuphict_in_out_ratio": 2,  # (k/mu_phi_ct)_in / (k/mu_phi_ct)_out
            "grp_flag": False,  # Параметр, обозначающий, был ли ГРП на скважине
            "grp_prop": {
                "hf": 60,  # Полудлина трещины, м
                "kf": 1500,  # Проницаемость трещины, дарси
                "wellbore_wf": 4.5,  # Ширина трещины у ствола скважины, мм
                "res_wf": 4.31,  # Ширина трещины на конце, мм
                "grade": 1,  # Степень аппроксимационной функции
                "skin_border": 0,  # Скин на стенке трещины
                "skin_ch": 0,  # Скин за счет схождения (Choke Skin)
                "fracture_grow_t": 0,  # Время роста трещины, ч
            },
            "mgrp_flag": False,  # Параметры МГРП
            "mgrp_prop": {
                    "grp_count": 2,  # Количество ГРП
                    "f_direction": "transverse"  # Направление трещин
                },
            "xe": 1000,  # Длина прямоугольника, м (в напр. Запад - Восток)
            "ye": 1000,  # Ширина прямоугольника, м (в напр. Север - Юг)
            "lc_ratio": 0.5,  # Доля от длины до центра
            "wc_rectangle_ratio": 0.5  # Доля от ширины до центра
        }
    }
}

input_data_fact = {
    "base_prop": {
        "calc_type": 'optimal',  # тип расчета (optimal упрощенная модель, desuperposition с эффектом суперпозиции
        # давления, segmentation сегментация скважины на интервалы)
        "segment_count": 20,  # кол-во сегментов разбиения скважины
        "border_type_x": "n",  # тип граничного условия (c - непроницаемая граница, n - свободный поток через границы)
        "border_type_y": "n",  # тип граничного условия
        "border_type_z_up": "n",  # тип граничного условия
        "border_type_z_down": "n",  # тип граничного условия
    },
    "target": {
        "cumulative_time": 2400,  # накопленное время работы, в сутках
        "target_values": {
            "q_liq": 50,  # целевое значение дебита
            "p_bhp": 150  # целевое значение забойного давления
        },
    },
    "unit": {
        "skin": 0,  # скин-фактор
        "h_eff": 12,  # Эффективная толщина пласта
        "vertical_offset": 0.5,  #
        "perfres_ratio": 1,  # Вертикальное положение (в долях от мощности) (для горизонтальных)
        "wellbore_prop": {
            "wellbore_type": "horizontal",  # Тип скважины: вертикальная, горизонтальная или многозабойная
            "wellbore_r": 0.1,  # Радиус скважины, м
            "horizontal_wellbore_length": 624,  # Длина горизонтального ствола
            "horizontal_wellbore_perf_ratio": 1,  # Доля перфораций горизонтальной скважины
            "horizontal_perf_count": 5,  # Количество перфорированных интервалов
            "permeability": 100000000  # Проницаемость скважины
        },
        "layer_prop": {
            "permeability": 15,  # Проницаемость пласта, мД
            "water_cut": 12,  # Обводненность, %
            "p_bubble": 100,  # Давление насыщения, атм
            "kv_kh_ratio": 0.1,  # Отношение вертикальной к горизонтальной проницаемости
            "compressibility": 0.00015,  # Общая сжимаемость
            "porosity": 0.2,  # Пористость
            "p_res_init": 260,  # Начальное пластовое давление
            "viscosity_oil": 1,  # Вязкость нефти
            "b_oil": 1.2,  # Объемный коэффициент
            "res_model_type": "Homogeneous",  # Модель пласта
            "f_compressibility": 0.0001,  # Сжимаемость трещин
            "f_porosity": 0.001,  # Пористость трещин
            "lambda": 0.00001,  # Коэффициент пропускания
            "internal_r": None,  # Внутренний радиус (для составной модели пласта)
            "kmu_in_out_ratio": 2,  # (k/mu)_in / (k/mu)_out
            "kmuphict_in_out_ratio": 2,  # (k/mu_phi_ct)_in / (k/mu_phi_ct)_out
            "grp_flag": False,  # Параметр, обозначающий, был ли ГРП на скважине
            "grp_prop": {
                "hf": 60,  # Полудлина трещины, м
                "kf": 1500,  # Проницаемость трещины, дарси
                "wellbore_wf": 4.5,  # Ширина трещины у ствола скважины, мм
                "res_wf": 4.31,  # Ширина трещины на конце, мм
                "grade": 1,  # Степень аппроксимационной функции
                "skin_border": 0,  # Скин на стенке трещины
                "skin_ch": 0,  # Скин за счет схождения (Choke Skin)
                "fracture_grow_t": 0,  # Время роста трещины, ч
            },
            "mgrp_flag": False,  # Параметры МГРП
            "mgrp_prop": {
                "grp_count": 2,  # Количество ГРП
                "f_direction": "transverse"  # Направление трещин
            },
            "xe": 1000,  # Длина прямоугольника, м (в напр. Запад - Восток)
            "ye": 1000,  # Ширина прямоугольника, м (в напр. Север - Юг)
            "lc_ratio": 0.5,  # Доля от длины до центра
            "wc_rectangle_ratio": 0.5  # Доля от ширины до центра
        }
    }
}

from src.use_cases.FA_calculator import FactorAnalysis

factor_analysis = FactorAnalysis(input_data_fact, input_data_plan, 100)
print(factor_analysis.calc_qkliq())

# import copy
# import numpy as np
# import pandas as pd
#
# from src.entities.models import TaskTarget
# from src.use_cases.calc import send_to_calc_flow_rate
#
# def get_nested_value(data, path):
#     """Получает значение по вложенному пути."""
#     for key in path:
#         data = data.get(key)
#         if data is None:
#             return None
#     return data
#
# def set_nested_value(data, path, value):
#     """Устанавливает значение по вложенному пути."""
#     target = data
#     for key in path[:-1]:
#         target = target.setdefault(key, {})
#     target[path[-1]] = value
#
#
# def compute_factor_impact(input_data_plan, param_path, plan_value, delta, factor_steps):
#     """Вычисляет влияние параметра методом трапеции.
#
#     Args:
#         input_data_plan: Плановые данные (словарь или объект).
#         param_path: Путь к параметру в виде списка ключей (например, ["unit", "layer_prop", "permeability"]).
#         plan_value: Плановое значение параметра.
#         delta: Изменение параметра (разница между фактическим и плановым).
#         factor_steps: Количество шагов для интегрирования.
#
#     Returns:
#         Интегральное влияние параметра на дебит жидкости.
#         Возвращает None в случае ошибки при расчете дебита.
#     """
#     Qk = np.zeros(factor_steps + 1)
#     for step in range(factor_steps + 1):
#         modified_value = plan_value + delta * step / factor_steps
#         modified_data = copy.deepcopy(input_data_plan) # deepcopy!
#         set_nested_value(modified_data, param_path, modified_value)
#
#         try:
#             calc_result = send_to_calc_flow_rate(modified_data)
#             Qk[step] = calc_result["result"]["flow_rate_result"]
#         except (KeyError, TypeError, Exception) as e:  # Обработка возможных ошибок
#             print(f"Error calculating flow rate: {e}")
#             return None
#
#     integrated_flow_rate = 0  # Более понятное имя
#     for i in range(factor_steps):
#         integrated_flow_rate += ((Qk[i + 1] + Qk[i]) / 2) * (delta / factor_steps)
#     return integrated_flow_rate
#
#
# def calc_qkliq(input_data_plan, input_data_fact, factor_steps=100):
#     """Расчет влияния факторов на дебит жидкости (Qkl) методом трапеции.
#
#     Args:
#         input_data_plan: Плановые входные данные (словарь или объект).
#         input_data_fact: Фактические входные данные (словарь или объект).
#         factor_steps: Количество шагов для расчета влияния факторов.
#
#     Returns:
#         Словарь с результатами влияния факторов.
#     """
#     results = {}
#     changeable_params = {
#         ["target", "target_values", "p_bhp"]: None,
#         ["unit", "h_eff"]: None,
#         ["unit", "layer_prop", "permeability"]: None,
#         ["unit", "layer_prop", "water_cut"]: None,
#         ["unit", "layer_prop", "p_res_init"]: None,
#         ["unit", "layer_prop", "grp_prop", "hf"]: None,
#         ["unit", "layer_prop", "grp_prop", "kf"]: None,
#         ["unit", "layer_prop", "grp_prop", "wellbore_wf"]: None,
#         ["unit", "layer_prop", "grp_prop", "res_wf"]: None,
#     }
#
#     for param_path, _ in changeable_params.items():
#         plan_value = get_nested_value(input_data_plan, param_path)
#         fact_value = get_nested_value(input_data_fact, param_path)
#
#         if plan_value is None or fact_value is None:
#             print(f"Warning: Parameter {param_path} not found in input data.")
#             continue
#
#         delta = fact_value - plan_value
#         results[".".join(param_path)] = compute_factor_impact(input_data_plan, param_path, plan_value, delta, factor_steps)
#
#     return results
#
# # Создание тестовых данных
# input_data_plan = TaskTarget(
#     base_prop={
#         "calc_type": "",  # Тип расчета (например, "steady_state", "transient") - неизменяемый параметр
#         "segment_count": 20,  # Количество сегментов для моделирования пласта - неизменяемый параметр
#         "border_type_x": "n",  # Тип граничного условия по оси X (например, "n" - Neumann) - неизменяемый параметр
#         "border_type_y": "n",  # Тип граничного условия по оси Y - неизменяемый параметр
#         "border_type_z_up": "n",  # Тип граничного условия по оси Z (верхняя граница) - неизменяемый параметр
#         "border_type_z_down": "n",  # Тип граничного условия по оси Z (нижняя граница) - неизменяемый параметр
#     },
#     target={
#         "time_step": 0.01,  # Шаг по времени моделирования (в сутках) - неизменяемый параметр
#         "number_of_steps": 1,  # Количество временных шагов - неизменяемый параметр
#         "cumulative_work_time": 100,  # Совокупное время работы скважины (в сутках) - неизменяемый параметр
#         "target_values": {
#             "q_liq": 50,  # Целевой дебит жидкости (м3/сут)
#             "p_bhp": 150  # Целевое забойное давление (бар)- изменяемый параметр
#         }
#     },
#     unit={
#         "skin": 0,  # Скин-фактор скважины - неизменяемый параметр
#         "h_eff": 10,  # Эффективная толщина пласта (м) - изменяемый параметр
#         "vertical_offset": 0.5,  # Вертикальное смещение (м)- неизменяемый параметр
#         "perfres_ratio": 1,  # Коэффициент сопротивления перфорации- неизменяемый параметр
#         "wellbore_prop": {
#             "wellbore_type": "horizontal",  # Тип скважины (горизонтальная, вертикальная)- неизменяемый параметр
#             "wellbore_r": 0.1,  # Радиус скважины (м)- неизменяемый параметр
#             "horizontal_wellbore_length": 624,  # Длина горизонтального участка скважины (м)- неизменяемый параметр
#             "horizontal_wellbore_perf_ratio": 1,
#             # Коэффициент перфорации горизонтального участка- неизменяемый параметр
#             "horizontal_perf_count": 5,  # Количество перфораций- неизменяемый параметр
#             "permeability": 100000000  # Проницаемость скважины (мД)- неизменяемый параметр
#         },
#         "layer_prop": {
#             "permeability": 10,  # Проницаемость пласта (мД) - изменяемый параметр
#             "water_cut": 10,  # Обводненность продукции (%) - изменяемый параметр
#             "p_bubble": 100,  # Давление насыщения (бар)- неизменяемый параметр
#             "kv_kh_ratio": 0.1,  # Отношение вертикальной и горизонтальной проницаемости - неизменяемый параметр
#             "compressibility": 0.00012,  # Сжимаемость пласта (1/бар) - неизменяемый параметр
#             "porosity": 0.2,  # Пористость пласта - неизменяемый параметр
#             "p_res_init": 250,  # Начальное пластовое давление (бар) - изменяемый параметр
#             "viscosity_oil": 1,  # Вязкость нефти (мПа*с)- неизменяемый параметр
#             "b_oil": 1.2,  # Объемный коэффициент нефти - неизменяемый параметр
#             "res_model_type": "Homogeneous",  # Тип модели пласта (однородный, неоднородный) - неизменяемый параметр
#             "f_compressibility": 0.0001,  # Сжимаемость флюида - неизменяемый параметр
#             "f_porosity": 0.001,  # Сжимаемость пористости  - неизменяемый параметр
#             "lambda": 0.00001,  # Коэффициент проводности (единицы зависят от системы) - неизменяемый параметр
#             "internal_r": None,  # Внутренний радиус (если применимо) - неизменяемый параметр
#             "kmu_in_out_ratio": 2,  # Отношение проницаемости внутри и снаружи  - неизменяемый параметр
#             "kmuphict_in_out_ratio": 2,
#             # Отношение проницаемости с учетом пористости внутри и снаружи - неизменяемый параметр
#             "grp_flag": False,  # Флаг наличия групп пропертив - изменяемый параметр
#             "grp_prop": {
#                 "hf": 60,  # Коэффициент трения (единицы зависят от системы) - изменяемый параметр
#                 "kf": 1400,  # Коэффициент фильтрации (единицы зависят от системы) - изменяемый параметр
#                 "wellbore_wf": 4.31,  # Гидродинамическое сопротивление скважины - изменяемый параметр
#                 "res_wf": 4.31,  # Гидродинамическое сопротивление пласта - изменяемый параметр
#                 "grade": 1,  # Класс пропертив (например, категория проницаемости) - неизменяемый параметр
#                 "skin_border": 0,  # Скин-фактор на границе  - неизменяемый параметр
#                 "skin_ch": 0,  # Скин-фактор по высоте  - неизменяемый параметр
#                 "fracture_grow_t": 0  # Время роста трещины - неизменяемый параметр
#                 },
#             "mgrp_flag": False,  # Флаг наличия множественных групп пропертив - неизменяемый параметр
#             "xe": 1000,  # Размер области моделирования по оси X - неизменяемый параметр
#             "ye": 1000,  # Размер области моделирования по оси Y - неизменяемый параметр
#             "lc_ratio": 0.5,  # Отношение длины ячейки - неизменяемый параметр
#             "wc_rectangle_ratio": 0.5  # Отношение ширины ячейки - неизменяемый параметр
#         }
#     }
# )
#
# input_data_fact = TaskTarget(
#
#     base_prop={
#
#         "calc_type": "",  # Тип расчета (например, "steady_state", "transient") - неизменяемый параметр
#         "segment_count": 20,  # Количество сегментов для моделирования пласта - неизменяемый параметр
#         "border_type_x": "n",  # Тип граничного условия по оси X (например, "n" - Neumann) - неизменяемый параметр
#         "border_type_y": "n",  # Тип граничного условия по оси Y - неизменяемый параметр
#         "border_type_z_up": "n",  # Тип граничного условия по оси Z (верхняя граница) - неизменяемый параметр
#         "border_type_z_down": "n",  # Тип граничного условия по оси Z (нижняя граница) - неизменяемый параметр
#     },
#
#     target={
#         "time_step": 0.01,  # Шаг по времени моделирования (в сутках) - неизменяемый параметр
#         "number_of_steps": 1,  # Количество временных шагов - неизменяемый параметр
#         "cumulative_work_time": 100,  # Совокупное время работы скважины (в сутках) - неизменяемый параметр
#         "target_values": {
#             "q_liq": 55,  # Целевой дебит жидкости (м3/сут) - изменяемый параметр
#             "p_bhp": 135  # Целевое забойное давление (бар) - изменяемый параметр
#         }
#     },
#     unit={
#         "skin": 0.1,  # Скин-фактор скважины - неизменяемый параметр
#         "h_eff": 11,  # Эффективная толщина пласта (м) - изменяемый параметр
#         "vertical_offset": 0.55,  # Вертикальное смещение (м) - неизменяемый параметр
#         "perfres_ratio": 1,  # Коэффициент сопротивления перфорации - неизменяемый параметр
#         "wellbore_prop": {
#             "wellbore_type": "horizontal",  # Тип скважины (горизонтальная, вертикальная) - неизменяемый параметр
#             "wellbore_r": 0.11,  # Радиус скважины (м) - неизменяемый параметр
#             "horizontal_wellbore_length": 686,  # Длина горизонтального участка скважины (м) - неизменяемый параметр
#             "horizontal_wellbore_perf_ratio": 1,
#             # Коэффициент перфорации горизонтального участка - неизменяемый параметр
#             "horizontal_perf_count": 6,  # Количество перфораций - неизменяемый параметр
#             "permeability": 100000000  # Проницаемость скважины (мД) - неизменяемый параметр
#         },
#         "layer_prop": {
#             "permeability": 11,  # Проницаемость пласта (мД) - изменяемый параметр
#             "water_cut": 11,  # Обводненность продукции (%) - изменяемый параметр
#             "p_bubble": 110,  # Давление насыщения (бар) - неизменяемый параметр
#             "kv_kh_ratio": 0.11,  # Отношение вертикальной и горизонтальной проницаемости - неизменяемый параметр
#             "compressibility": 0.000132,  # Сжимаемость пласта (1/бар) - неизменяемый параметр
#             "porosity": 0.22,  # Пористость пласта - неизменяемый параметр
#             "p_res_init": 275,  # Начальное пластовое давление (бар) - изменяемый параметр
#             "viscosity_oil": 1.1,  # Вязкость нефти (мПа*с) - неизменяемый параметр
#             "b_oil": 1.32,  # Объемный коэффициент нефти - неизменяемый параметр
#             "res_model_type": "Homogeneous",  # Тип модели пласта (однородный, неоднородный) - неизменяемый параметр
#             "f_compressibility": 0.00011,  # Сжимаемость флюида - неизменяемый параметр
#             "f_porosity": 0.0011,  # Сжимаемость пористости - неизменяемый параметр
#             "lambda": 0.000011,  # Коэффициент проводности (единицы зависят от системы) - неизменяемый параметр
#             "internal_r": None,  # Внутренний радиус (если применимо) - неизменяемый параметр
#             "kmu_in_out_ratio": 2,  # Отношение проницаемости внутри и снаружи - неизменяемый параметр
#             "kmuphict_in_out_ratio": 2,
#             # Отношение проницаемости с учетом пористости внутри и снаружи - неизменяемый параметр
#             "grp_flag": False,  # Флаг наличия групп пропертив - изменяемый параметр
#             "grp_prop": {
#                 "hf": 60,  # Коэффициент трения (единицы зависят от системы) - изменяемый параметр
#                 "kf": 1400,  # Коэффициент фильтрации (единицы зависят от системы) - изменяемый параметр
#                 "wellbore_wf": 4.31,  # Гидродинамическое сопротивление скважины - изменяемый параметр
#                 "res_wf": 4.31,  # Гидродинамическое сопротивление пласта - изменяемый параметр
#                 "grade": 1,  # Класс пропертив (например, категория проницаемости) - неизменяемый параметр
#                 "skin_border": 0,  # Скин-фактор на границе - неизменяемый параметр
#                 "skin_ch": 0,  # Скин-фактор по высоте - неизменяемый параметр
#                 "fracture_grow_t": 0  # Время роста трещины - неизменяемый параметр
#
#             },
#
#             "mgrp_flag": False,  # Флаг наличия множественных групп пропертив - неизменяемый параметр
#             "xe": 1000,  # Размер области моделирования по оси X - неизменяемый параметр
#             "ye": 1000,  # Размер области моделирования по оси Y - неизменяемый параметр
#             "lc_ratio": 0.5,  # Отношение длины ячейки - неизменяемый параметр
#             "wc_rectangle_ratio": 0.5  # Отношение ширины ячейки - неизменяемый параметр
#         }
#     }
# )